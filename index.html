<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TiroScore</title>
  <style>
    :root{
      --bg:#071022; --card:#0b1220; --accent:#06b6d4; --muted:#94a3b8; --glass:rgba(255,255,255,0.03);
      --gap:12px; --radius:10px;
    }
    /* Mobile-first layout */
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(180deg,#071121 0%,#081827 100%);color:#e6eef6;padding:16px}
    .wrap{max-width:1100px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
    .profile{display:flex;align-items:center;gap:12px}
    .avatar{width:44px;height:44px;border-radius:999px;background:linear-gradient(180deg,#0ea5a3,#06b6d4);display:flex;align-items:center;justify-content:center;color:#042;font-weight:700}
    h1{font-size:16px;margin:0}
    .meta{font-size:13px;color:var(--muted)}

    /* responsive grid: stacks on mobile, columns on larger */
    .grid{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:14px}
    .card{background:var(--card);padding:12px;border-radius:var(--radius);box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    .kpi{font-size:22px;font-weight:700}
    .muted{color:var(--muted);font-size:13px}
    .barwrap{display:flex;gap:8px;align-items:end;height:110px;padding:8px;background:var(--glass);border-radius:8px;overflow:hidden}
    .bar{flex:1;background:linear-gradient(180deg,var(--accent),#0ea5a3);border-radius:6px;display:flex;align-items:flex-end;justify-content:center;color:#012;font-weight:700}
    .pill{background:rgba(255,255,255,0.04);padding:6px 8px;border-radius:999px;font-size:13px}
    table{width:100%;border-collapse:collapse;margin-top:8px;font-size:13px}
    th,td{padding:8px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.03)}
    .right{text-align:right}
    .sheet table th{background:rgba(255,255,255,0.02);font-size:13px}
    .summary{display:flex;gap:12px;align-items:center;margin-top:12px;padding:10px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01))}
    .summary > div{flex:1}

    /* larger screens: 3-column main area */
    @media(min-width:800px){
      .grid{grid-template-columns:repeat(3,1fr)}
      header h1{font-size:18px}
      .kpi{font-size:28px}
    }

    /* more breathing on very large screens */
    @media(min-width:1200px){
      body{padding:28px}
      .wrap{max-width:1300px}
    }

    button{background:var(--accent);color:#042;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="display:flex;align-items:center;gap:12px">
        <div class="profile">
          <div class="avatar">AP</div>
          <div>
            <h1 id="arqueroName">Alfio Perino</h1>
            <div class="meta">Arquero · Arquería Pinamar CET · 3D</div>
          </div>
        </div>
      </div>
      <div>
        <button id="downloadJson">Descargar JSON</button>
      </div>
    </header>

    <div class="grid" id="kpis">
      <div class="card">
        <div class="muted">Intentos totales</div>
        <div class="kpi" id="kpiAttempts">—</div>
      </div>
      <div class="card">
        <div class="muted">Puntos totales</div>
        <div class="kpi" id="kpiPoints">—</div>
      </div>
      <div class="card">
        <div class="muted">Veces con 'MM'</div>
        <div class="kpi" id="kpiDobleM">—</div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="muted">Distribución de puntajes (por cantidad)</div>
        <div id="bars" class="barwrap" aria-hidden="false"></div>
        <div id="labels" style="margin-top:8px;display:flex;justify-content:space-between;font-size:13px;color:var(--muted)"></div>

        <!-- Movido: Estaciones con 'MM' (ahora aquí, debajo del gráfico) -->
        <div style="margin-top:10px" class="muted">Estaciones con 'MM'</div>
        <div id="dobleM" style="margin-top:8px"></div>
      </div>

      <div class="card">
        <div class="muted">Detalle por puntaje</div>
        <table id="puntajeTable" aria-describedby="Detalle puntajes">
          <thead>
            <tr><th>Puntaje</th><th>Cantidad</th><th>% de disparos</th><th>Puntos totales</th><th>% de puntos</th></tr>
          </thead>
          <tbody></tbody>
        </table>

        <div id="puntajeSummary" class="summary" aria-hidden="false">
          <div>
            <div class="muted">Total de puntos</div>
            <div id="sumTotalPoints" style="font-size:18px;font-weight:800;color:var(--accent)">—</div>
          </div>
          <div>
            <div class="muted">Total 10 (veces)</div>
            <div id="sumTotal10" style="font-size:16px;font-weight:800">—</div>
          </div>
          <div>
            <div class="muted">Total 11 (veces)</div>
            <div id="sumTotal11" style="font-size:16px;font-weight:800">—</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="muted">Rangos de distancia</div>
        <div class="pill" id="rangosText" style="margin-top:8px"></div>
        <div style="margin-top:10px" class="muted">Estaciones por rango</div>
        <div id="rangosList" style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap"></div>

        <!-- NUEVO: Estaciones por altura -->
        <div style="margin-top:10px" class="muted">Estaciones por altura</div>
        <div id="estacionesAlturaList" style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap"></div>

        <!-- nota: la sección de 'Estaciones con MM' fue MOVIDA arriba (debajo del gráfico) -->
      </div>
    </div>

    <!-- Planilla -->
    <div class="card sheet" style="margin-top:14px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="muted">Planilla de disparos</div>
          <div class="meta">Resumen por estación — 24 disparos (2 vueltas)</div>
        </div>
        <div class="meta">Intentos: <span id="metaAttempts">-</span> · Puntos: <span id="metaPoints">-</span></div>
      </div>

      <table id="sheetTable" style="margin-top:10px">
        <thead>
          <tr>
            <th style="width:64px">N°</th>
            <th style="width:78px">Dist (m)</th>
            <th>Altura</th>
            <th style="width:64px">Disp. 1</th>
            <th style="width:64px">Disp. 2</th>
            <th style="width:78px">Total est.</th>
            <th style="width:96px">Acumulado</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <!-- ADICION: distribuciones solicitadas -->
      <div id="distribuciones" style="margin-top:14px;display:grid;grid-template-columns:1fr;gap:12px">
        <div class="card" id="distByRangeCard">
          <div class="muted">Distribución por rango de distancia</div>
          <div style="overflow:auto;margin-top:8px">
            <table id="distRangeTable" style="min-width:320px">
              <thead>
                <tr><th>Puntaje</th><th>Corta</th><th>Media</th><th>Larga</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="card" id="distByAlturaCard">
          <div class="muted">Distribución por altura (Alta / Plana / Baja)</div>
          <div style="overflow:auto;margin-top:8px">
            <table id="alturaTable" style="min-width:320px">
              <thead>
                <tr><th>Puntaje</th><th>Alta</th><th>Plana</th><th>Baja</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <div class="muted">Lista de puntajes</div>
        <div id="puntajePills" style="display:flex;gap:8px;flex-wrap:wrap"></div>
      </div>
    </div>

    <footer style="margin-top:14px" id="metaFooter"></footer>
  </div>

  <script type="module">
    import tiroData from './index.js';

    const el = (tag, cls, txt) => { const e=document.createElement(tag); if(cls) e.className=cls; if(txt!==undefined) e.textContent=txt; return e; };

    // KPIs
    document.getElementById('kpiAttempts').textContent = tiroData.totalAttempts ?? 0;
    document.getElementById('kpiPoints').textContent = tiroData.totalPoints ?? 0;
    document.getElementById('kpiDobleM').textContent = (tiroData.dobleMCount ?? 0);

    // Bars
    const scoreKeys = ['M','5','8','10','11'];
    const counts = {
      M: tiroData.puntajeM.cantidad,
      5: tiroData.puntaje5.cantidad,
      8: tiroData.puntaje8.cantidad,
      10: tiroData.puntaje10.cantidad,
      11: tiroData.puntaje11.cantidad
    };
    const maxCount = Math.max(...Object.values(counts),1);
    const bars = document.getElementById('bars');
    const labels = document.getElementById('labels');
    scoreKeys.forEach(k=>{
      const count = counts[k] || 0;
      const h = (count/maxCount)*100;
      const b = el('div','bar', count ? String(count) : '');
      b.style.height = Math.max(6,h)+'%';
      b.title = k + ': ' + count;
      bars.appendChild(b);
      labels.appendChild(el('div','',''+k));
    });

    // Puntaje table
    const tbody = document.querySelector('#puntajeTable tbody');
    function addRow(name, obj){
      const cantidad = obj.cantidad ?? 0;
      const total = obj.total ?? (cantidad * (name === 'M' ? 0 : Number(name)));
      const porcentajeDisparos = obj.porcentaje ?? obj.porcentajeDisparos ?? (tiroData.totalAttempts ? parseFloat(((cantidad/tiroData.totalAttempts)*100).toFixed(2)) : 0);
      const porcentajePuntos = obj.porcentajePuntos ?? (tiroData.totalPoints ? parseFloat(((total/(tiroData.totalPoints))*100).toFixed(2)) : 0);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${name}</td><td>${cantidad}</td><td>${porcentajeDisparos}%</td><td>${total}</td><td>${porcentajePuntos}%</td>`;
      tbody.appendChild(tr);
    }
    addRow('M', tiroData.puntajeM);
    addRow('5', tiroData.puntaje5);
    addRow('8', tiroData.puntaje8);
    addRow('10', tiroData.puntaje10);
    addRow('11', tiroData.puntaje11);

    // summary blocks (uses counts for 10/11, not total points)
    document.getElementById('sumTotalPoints').textContent = tiroData.totalPoints ?? 0;
    const total10Count = (tiroData.puntaje10 && (tiroData.puntaje10.cantidad ?? 0)) || 0;
    const total11Count = (tiroData.puntaje11 && (tiroData.puntaje11.cantidad ?? 0)) || 0;
    document.getElementById('sumTotal10').textContent = total10Count;
    document.getElementById('sumTotal11').textContent = total11Count;

    // Rangos & doble M
    (function renderRangosAndDobleM() {
      const [cMin,cMax] = tiroData.distanciaCorta ?? [null,null];
      const [mMin,mMax] = tiroData.distanciaMedia ?? [null,null];
      const [lMin,lMax] = tiroData.distanciaLarga ?? [null,null];

      document.getElementById('rangosText').textContent =
        `Corta: ${cMin} - ${cMax} | Media: ${mMin} - ${mMax} | Larga: ${lMin} - ${lMax}`;

      const rList = document.getElementById('rangosList');
      rList.innerHTML = '';
      rList.appendChild(el('div','pill','Corta: ' + ((tiroData.estacionesCorta||[]).join(', ') || '—')));
      rList.appendChild(el('div','pill','Media: ' + ((tiroData.estacionesMedia||[]).join(', ') || '—')));
      rList.appendChild(el('div','pill','Larga: ' + ((tiroData.estacionesLarga||[]).join(', ') || '—')));

      // Estaciones por altura: calcular a partir de tiroData.estaciones
      const alturaListEl = document.getElementById('estacionesAlturaList');
      alturaListEl.innerHTML = '';
      const altas = [], medias = [], bajas = [];
      const estacionesObj = tiroData.estaciones || {};
      Object.entries(estacionesObj).forEach(([id, meta]) => {
        const h = (meta && meta.altura || '').toString().toLowerCase();
        if (h === 'alto') altas.push(id);
        else if (h === 'medio') medias.push(id);
        else bajas.push(id);
      });
      alturaListEl.appendChild(el('div','pill','Altas: ' + (altas.join(', ') || '—')));
      alturaListEl.appendChild(el('div','pill','Medias: ' + (medias.join(', ') || '—')));
      alturaListEl.appendChild(el('div','pill','Bajas: ' + (bajas.join(', ') || '—')));

      const dm = document.getElementById('dobleM');
      dm.innerHTML = '';
      dm.appendChild(el('div','pill', (tiroData.estacionesDobleM && tiroData.estacionesDobleM.length) ? tiroData.estacionesDobleM.join(', ') : '—'));
    })();

    // Planilla rows in object key order (1..24). Show mapped physical station and vuelta in small label.
    const sheetTbody = document.querySelector('#sheetTable tbody');
    let acumulado = 0;
    const safeVal = v => (v === 'M' ? 0 : (Number(v) || 0));
    const estacionesObj = tiroData.estaciones || {};
    const keys = Object.keys(tiroData.arquero).map(k=>Number(k)).sort((a,b)=>a-b);

    keys.forEach(keyNum => {
      const s = tiroData.arquero[keyNum] || { disparo1:'-', disparo2:'-' };
      const d1 = s.disparo1 !== undefined ? s.disparo1 : '-';
      const d2 = s.disparo2 !== undefined ? s.disparo2 : '-';
      const totEst = safeVal(d1) + safeVal(d2);
      acumulado += totEst;

      const estacionFisica = ((keyNum - 1) % 12) + 1;
      const vuelta = keyNum <= 12 ? 1 : 2;
      const estMeta = estacionesObj[estacionFisica] || {};

      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${keyNum} <span style="color:var(--muted);font-size:11px">Estaca${estacionFisica}·Vuelta${vuelta}</span></td>` +
                     `<td class="right">${estMeta.distancia ?? '—'}</td>` +
                     `<td>${estMeta.altura ?? '—'}</td>` +
                     `<td>${d1}</td><td>${d2}</td>` +
                     `<td class="right">${totEst}</td><td class="right">${acumulado}</td>`;
      sheetTbody.appendChild(tr);
    });

    // Insert summary rows into planilla BEFORE the pills area
    const makeSummaryRow = (label, value) => {
      const tr = document.createElement('tr');
      tr.innerHTML =
        `<td colspan="3" style="font-weight:800;font-size:14px">${label}</td>` +
        `<td colspan="2"></td>` +
        `<td style="font-weight:900;color:var(--accent);text-align:right">${value}</td>` +
        `<td></td>`;
      return tr;
    };
    const sheetTotalPoints = tiroData.totalPoints ?? 0;
    sheetTbody.appendChild(makeSummaryRow('TOTAL DE PUNTOS', sheetTotalPoints));
    sheetTbody.appendChild(makeSummaryRow('TOTAL 10 (veces)', total10Count));
    sheetTbody.appendChild(makeSummaryRow('TOTAL 11 (veces)', total11Count));

    // --- NUEVO: Distribuciones por rango y por altura (con % por columna) ---
    (function renderDistribuciones() {
      const scores = ['M','5','8','10','11'];

      // prepare counters
      const ranges = { corta: {}, media: {}, larga: {} };
      const alturas = { alta: {}, plana: {}, baja: {} };
      scores.forEach(s => {
        ranges.corta[s]=0; ranges.media[s]=0; ranges.larga[s]=0;
        alturas.alta[s]=0; alturas.plana[s]=0; alturas.baja[s]=0;
      });

      // distance boundaries from tiroData (arrays [min, max])
      const [cMin,cMax] = tiroData.distanciaCorta ?? [null,null];
      const [mMin,mMax] = tiroData.distanciaMedia ?? [null,null];
      const [lMin,lMax] = tiroData.distanciaLarga ?? [null,null];

      const getRangeKey = (dist) => {
        if (dist === null || dist === undefined) return null;
        const d = Number(dist);
        if (!Number.isFinite(d)) return null;
        if (d >= cMin && d < cMax) return 'corta';
        if (d >= mMin && d < mMax) return 'media';
        if (d >= lMin && d <= lMax) return 'larga';
        return 'larga';
      };

      // iterate shots (1..24) using object order keys
      Object.keys(tiroData.arquero).map(k=>Number(k)).sort((a,b)=>a-b).forEach(n=>{
        const entry = tiroData.arquero[n] || {};
        // map to physical station 1..12
        const estacionFisica = ((n - 1) % 12) + 1;
        const meta = tiroData.estaciones && tiroData.estaciones[estacionFisica] ? tiroData.estaciones[estacionFisica] : {};
        const dist = meta.distancia;
        const rawAlt = (meta.altura || '').toString().toLowerCase();
        // normalize altura -> alta / plana / baja
        const alturaKey = rawAlt === 'alto' ? 'alta' : (rawAlt === 'medio' ? 'plana' : 'baja');

        const shots = [entry.disparo1, entry.disparo2];
        shots.forEach(sh => {
          const s = (sh === undefined || sh === null) ? null : String(sh);
          if (s === null) return;
          const range = getRangeKey(dist);
          if (range) ranges[range][s] = (ranges[range][s]||0)+1;
          alturas[alturaKey][s] = (alturas[alturaKey][s]||0)+1;
        });
      });

      // totales por columna (para calcular %)
      const totalRangeCounts = {
        corta: Object.values(ranges.corta).reduce((a,b)=>a+b,0),
        media: Object.values(ranges.media).reduce((a,b)=>a+b,0),
        larga: Object.values(ranges.larga).reduce((a,b)=>a+b,0)
      };
      const totalAltCounts = {
        alta: Object.values(alturas.alta).reduce((a,b)=>a+b,0),
        plana: Object.values(alturas.plana).reduce((a,b)=>a+b,0),
        baja: Object.values(alturas.baja).reduce((a,b)=>a+b,0)
      };

      // render helpers: mostrar "count (pct%)"
      const cellText = (count, total) => {
        const pct = total > 0 ? ((count/total)*100).toFixed(1) : '0.0';
        return `${count} (${pct}%)`;
      };

      // render tables
      const distBody = document.querySelector('#distRangeTable tbody');
      const alturaBody = document.querySelector('#alturaTable tbody');
      // clear existing
      distBody.innerHTML = '';
      alturaBody.innerHTML = '';

      scores.forEach(score=>{
        const cortaCount = ranges.corta[score] || 0;
        const mediaCount = ranges.media[score] || 0;
        const largaCount = ranges.larga[score] || 0;
        const trR = document.createElement('tr');
        trR.innerHTML = `<td>${score}</td><td>${cellText(cortaCount, totalRangeCounts.corta)}</td><td>${cellText(mediaCount, totalRangeCounts.media)}</td><td>${cellText(largaCount, totalRangeCounts.larga)}</td>`;
        distBody.appendChild(trR);

        const altaCount = alturas.alta[score] || 0;
        const planaCount = alturas.plana[score] || 0;
        const bajaCount = alturas.baja[score] || 0;
        const trA = document.createElement('tr');
        trA.innerHTML = `<td>${score}</td><td>${cellText(altaCount, totalAltCounts.alta)}</td><td>${cellText(planaCount, totalAltCounts.plana)}</td><td>${cellText(bajaCount, totalAltCounts.baja)}</td>`;
        alturaBody.appendChild(trA);
      });
    })();
    // --- fin distribuciones ---

    // fill pills list
    document.getElementById('metaAttempts').textContent = tiroData.totalAttempts ?? 0;
    document.getElementById('metaPoints').textContent = tiroData.totalPoints ?? 0;

    const puntajePills = document.getElementById('puntajePills');
    const pts = [
      { label:'M', obj: tiroData.puntajeM },
      { label:'5', obj: tiroData.puntaje5 },
      { label:'8', obj: tiroData.puntaje8 },
      { label:'10', obj: tiroData.puntaje10 },
      { label:'11', obj: tiroData.puntaje11 }
    ];
    pts.forEach(p=>{
      const cantidad = p.obj.cantidad ?? 0;
      const total = p.obj.total ?? (cantidad * (p.label === 'M' ? 0 : Number(p.label)));
      puntajePills.appendChild(el('div','pill', `${p.label} — ${cantidad} · pts: ${total}`));
    });

    // footer meta
    document.getElementById('metaFooter').textContent = `Distancia mínima: ${tiroData.distanciaMinima} — Distancia máxima: ${tiroData.distanciaMaxima}`;

    document.getElementById('downloadJson').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(tiroData, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'tiroData.json'; a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>